package me.redstom.tickettools.utils.messages;

import java.awt.*;
import java.time.Instant;
import me.redstom.tickettools.commands.ping.PingComputer;
import me.redstom.tickettools.commands.ticket.TicketOpeningReason;
import me.redstom.tickettools.utils.messages.builder.MessageFactory;
import me.redstom.tickettools.utils.messages.builder.data.TicketMessage;
import net.dv8tion.jda.api.EmbedBuilder;
import net.dv8tion.jda.api.entities.*;
import net.dv8tion.jda.api.entities.channel.concrete.TextChannel;
import net.dv8tion.jda.api.entities.channel.middleman.GuildMessageChannel;
import net.dv8tion.jda.api.entities.emoji.Emoji;
import net.dv8tion.jda.api.interactions.components.buttons.ButtonStyle;
import org.springframework.stereotype.Component;

@Component
public class Embeds {

    public EmbedBuilder error(String message) {
        return new EmbedBuilder().setColor(Color.RED).addField("Erreur :", "> " + message, false);
    }

    public TicketMessage errorMessage(String message) {
        return MessageFactory.create().addEmbeds(error(message));
    }

    public EmbedBuilder success(String message) {
        return new EmbedBuilder().setColor(Color.GREEN).setTitle("Succ√®s").setDescription(message);
    }

    public TicketMessage successMessage(String message) {
        return MessageFactory.create().addEmbeds(success(message));
    }

    public EmbedBuilder ticketAlreadyExists(boolean personal) {
        return error(
                personal
                        ? "Vous avez d√©j√† un ticket ouvert avec la mod√©ration."
                        : "Un ticket est d√©j√† ouvert avec cet utilisateur.");
    }

    public TicketMessage ticketAlreadyExistsMessage(GuildMessageChannel ticketChannel, boolean personal) {
        // spotless:off
        return MessageFactory.create()
                .addEmbeds(ticketAlreadyExists(personal))
                .addActionRow(actionRow -> actionRow
                        .addButton(button -> button
                                .setText("Aller au ticket")
                                .setLink(ticketChannel.getJumpUrl())
                        )
                );
        // spotless:on
    }

    public TicketMessage ping(PingComputer manager) {
        EmbedBuilder embed = new EmbedBuilder()
                .setTitle(":ping_pong: Pong !")
                .setColor(Color.green)
                .addField("‚ÜîÔ∏è Ping du Gateway :", "\n**`%s`** ms".formatted(manager.getGatewayPing()), false)
                .addField("‚û°Ô∏è Ping de l'API :", "\n**`%s`** ms".formatted(manager.getRestPing()), false);

        // spotless:off
        return MessageFactory.create()
                .addEmbeds(embed)
                .addActionRow(actionRow -> actionRow
                        .addButton("refresh-ping", button -> button
                                .setStyle(ButtonStyle.PRIMARY)
                                .setText("Actualiser")
                                .setEmoji(Emoji.fromUnicode("üîÅ"))
                        )
                );
        // spotless:on
    }

    public EmbedBuilder noTicketAttached() {
        return error("Impossible de trouver un ticket rattach√© √† ce salon");
    }

    public TicketMessage noTicketAttachedMessage() {
        return MessageFactory.create().addEmbeds(noTicketAttached());
    }

    public EmbedBuilder proposeOpening(String sentEmote) {
        return new EmbedBuilder()
                .setAuthor("Message automatique")
                .setTitle("Ticket en cours d'ouverture !")
                .setDescription(
                        """
                                Votre demande d'ouverture de ticket a bien √©t√© prise en compte.
                                Veuillez cependant confirmer que vous avez pris connaissance des r√®gles de ceux-cis.
                                """)
                .addField(
                        "‚úâÔ∏è R√®gles des tickets :",
                        """
                                - Les messages que vous envoyez ne peuvent ni √™tre √©dit√©s, ni √™tre supprim√©s.
                                - Tous les messages envoy√©s sont enregistr√©s.
                                - Les r√®gles du discord `Graven - D√©veloppement` sont √©galement applicables dans les tickets.
                                - Les tickets ouverts sans justification seront sanctionn√©s.
                                - Les tickets sont destin√©s √† la mod√©ration. Les demandes d'aides sont susceptibles d'√™tre sanctionn√©es.
                                """,
                        false)
                .addField(
                        "‚ùî Utilisation :",
                        String.format(
                                """
                                        - Pour transmettre un message, vous avez juste √† envoyer un message en priv√© avec ce bot.
                                        - Les r√©ponses de la mod√©ration se feront par le biais de ces message priv√©s.
                                        - Si votre message est transmis, la r√©action %s sera ajout√©e √† vos messages
                                        """,
                                sentEmote),
                        false)
                .addField(
                        "‚ú® Terminer l'ouverture du ticket",
                        """
                                Afin de terminer l'ouverture du ticket, merci de s√©lectionner ci-dessous la raison de l'ouverture de votre ticket.
                                Vous serez ensuite recontact√© dans les plus brefs d√©lais.
                                """,
                        false)
                .setColor(Color.GREEN);
    }

    public EmbedBuilder forceOpening(String sentEmote, TicketOpeningReason reason) {
        String reasonAsString =
                switch (reason) {
                    case TicketOpeningReason.Empty r -> "Aucune raison n'a √©t√© sp√©cifi√©e";
                    case TicketOpeningReason.Simple r -> r.reason();
                    case TicketOpeningReason.UserReport r -> "Signalement utilisateur √† cause de : %s"
                            .formatted(r.reportReason());
                };
        return new EmbedBuilder()
                .setAuthor("Message automatique")
                .setTitle("Ticket ouvert !")
                .setDescription(
                        """
                                La mod√©ration a ouvert un ticket vous impliquant.
                                Vous pouvez d√©sormais discuter avec le staff en message priv√© avec le bot
                                """)
                .addField(
                        "‚úâÔ∏è R√®gles des tickets :",
                        """
                                - Les messages que vous envoyez ne peuvent ni √™tre √©dit√©s, ni √™tre supprim√©s.
                                - Tous les messages envoy√©s sont enregistr√©s.
                                - Les r√®gles du discord `Graven - D√©veloppement` sont √©galement applicables dans les tickets.
                                """,
                        false)
                .addField(
                        "‚ùî Utilisation :",
                        String.format(
                                """
                                        - Pour transmettre un message, vous avez juste √† envoyer un message en priv√© avec ce bot.
                                        - Les r√©ponses de la mod√©ration se feront par le biais de ces message priv√©s.
                                        - Si votre message est transmis, la r√©action %s sera ajout√©e √† vos messages
                                        """,
                                sentEmote),
                        false)
                .addField(
                        "‚ö†Ô∏è Avertissement :",
                        """
                                Ce ticket a √©t√© ouvert par la mod√©ration pour la raison suivante :
                                ```
                                %s
                                ```
                                """
                                .formatted(reasonAsString),
                        false)
                .setColor(Color.ORANGE);
    }

    public EmbedBuilder ticketOpening(boolean forced, User by, User from, TextChannel channel, String reason) {
        return new EmbedBuilder()
                .setTitle("Ticket ouvert")
                .setColor(forced ? Color.CYAN : Color.GREEN)
                .setTimestamp(Instant.now())
                .setThumbnail(from.getAvatarUrl())
                .addField(
                        "‚ÑπÔ∏è D√©tails :",
                        """
                                > **Identifiant de l'utilisateur**
                                %s

                                > **Nom de l'utilisateur**
                                %s (`@%s`)

                                :hash: **Salon**
                                %s (`#%s`)

                                üìù **Raison**
                                `%s`

                                %s
                                """
                                .formatted(
                                        from.getId(),
                                        from.getAsMention(),
                                        from.getAsTag(),
                                        channel.getAsMention(),
                                        channel.getName(),
                                        reason,
                                        forced
                                                ? String.format(
                                                        """
                                                 üõÇ **Ouvert par**
                                                 %s (`@%s`)

                                                """,
                                                        by.getAsMention(), by.getAsTag())
                                                : ""),
                        false);
    }

    public EmbedBuilder ticketClosing(User from, String jumpUrl) {
        return new EmbedBuilder()
                .setTitle("Ticket ferm√©")
                .setColor(Color.RED)
                .setTimestamp(Instant.now())
                .setThumbnail(from.getAvatarUrl())
                .addField(
                        "‚ÑπÔ∏è D√©tails :",
                        String.format(
                                """
                                        > **Identifiant de l'utilisateur**
                                        %s

                                        > **Nom de l'utilisateur**
                                        %s (`@%s`)

                                        :spiral_note_pad: **Rapport**
                                        [Lien du rapport](%s)
                                        """,
                                from.getId(), from.getAsMention(), from.getAsTag(), jumpUrl),
                        false);
    }
}
